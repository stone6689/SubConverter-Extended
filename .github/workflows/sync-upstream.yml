name: Sync upstream and replay patches

on:
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Add upstream and fetch
        run: |
          git remote add upstream https://github.com/asdlokj1qpi233/subconverter.git || true
          git fetch upstream --prune

      - name: Update upstream-master branch
        id: update_upstream
        run: |
          git checkout upstream-master
          
          # Check if upstream has new commits
          if git diff --quiet upstream-master upstream/master; then
            echo "No updates from upstream, skipping sync."
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            echo "Upstream has updates, syncing..."
            git reset --hard upstream/master
            git push origin upstream-master --force
            echo "updated=true" >> $GITHUB_OUTPUT
          fi

      - name: Rebase master onto upstream-master (sync source code only)
        if: steps.update_upstream.outputs.updated == 'true'
        run: |
          set -e
          git checkout master
          
          # Backup customized files that should not be synced from upstream
          echo "Backing up customized files..."
          mkdir -p .backup
          cp -r .github .backup/.github
          cp Dockerfile .backup/Dockerfile
          cp README.md .backup/README.md
          
          # Attempt to rebase
          if git rebase upstream-master; then
            echo "Rebase successful. Applying patches..."
            
            # Apply all patches from .patches directory
            if [ -d ".patches" ] && [ "$(ls -A .patches/*.patch 2>/dev/null)" ]; then
              for patch_file in .patches/*.patch; do
                echo "Applying patch: $(basename $patch_file)"
                if git am "$patch_file"; then
                  echo "✓ Patch applied successfully: $(basename $patch_file)"
                else
                  echo "✗ Failed to apply patch: $(basename $patch_file)"
                  echo "Aborting patch application..."
                  git am --abort || true
                  
                  # Restore files and abort rebase
                  rm -rf .github Dockerfile README.md
                  mv .backup/.github .github
                  mv .backup/Dockerfile Dockerfile
                  mv .backup/README.md README.md
                  rm -rf .backup
                  
                  git reset --hard HEAD
                  git rebase --abort || true
                  exit 1
                fi
              done
            else
              echo "No patches found in .patches directory, skipping patch application."
            fi
            
            echo "Restoring customized configuration files..."
            
            # Restore customized files
            rm -rf .github
            mv .backup/.github .github
            cp .backup/Dockerfile Dockerfile
            cp .backup/README.md README.md
            
            # Stage and amend the changes
            git add .github Dockerfile README.md
            if git diff --cached --quiet; then
              echo "No changes to customized files, pushing directly..."
            else
              echo "Committing restored customized files..."
              git commit --amend --no-edit
            fi
            
            # Push to remote
            git push origin master --force-with-lease
            
            # Cleanup
            rm -rf .backup
          else
            echo "Rebase failed. Showing status and conflicts:"
            git status --porcelain || true
            git diff --name-only --diff-filter=U || true
            
            # Restore files and abort
            rm -rf .github Dockerfile README.md
            mv .backup/.github .github
            mv .backup/Dockerfile Dockerfile
            mv .backup/README.md README.md
            rm -rf .backup/README.md README.md
            rm -rf .backup
            
            git rebase --abort || true
            exit 1
          fi
