name: Cleanup Failed Workflows

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete all failed, cancelled and skipped workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            console.log('๐งน Cleaning up failed, cancelled and skipped workflow runs...');
            console.log('');
            
            let deletedCount = 0;
            let page = 1;
            const perPage = 100;
            
            while (true) {
              const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: perPage,
                page: page,
                status: 'completed'
              });
              
              if (runs.workflow_runs.length === 0) {
                break;
              }
              
              for (const run of runs.workflow_runs) {
                // Delete failed, cancelled and skipped runs
                if (run.conclusion === 'failure' || 
                    run.conclusion === 'cancelled' ||
                    run.conclusion === 'skipped') {
                  
                  const runInfo = `[${run.conclusion.toUpperCase()}] ${run.name} #${run.run_number}`;
                  
                  try {
                    await github.rest.actions.deleteWorkflowRun({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      run_id: run.id
                    });
                    console.log(`โ Deleted: ${runInfo}`);
                    deletedCount++;
                    
                    // Rate limiting
                    await new Promise(resolve => setTimeout(resolve, 100));
                  } catch (error) {
                    console.log(`โ Failed: ${runInfo} - ${error.message}`);
                  }
                }
              }
              
              page++;
              
              if (page > 100) {
                console.log('โ๏ธ  Reached page limit, stopping...');
                break;
              }
            }
            
            console.log('');
            console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
            console.log(`โ Cleanup completed!`);
            console.log(`๐ Deleted ${deletedCount} workflow runs`);
            console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
