name: Cleanup Failed Workflows

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete failed workflow runs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set +e  # Don't exit on error
          
          echo "ğŸ§¹ Starting cleanup of failed, cancelled and skipped workflow runs..."
          echo ""
          
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          
          deleted=0
          failed=0
          page=1
          
          while [ $page -le 50 ]; do
            echo "ğŸ“„ Fetching page $page..."
            
            # Get workflow runs
            response=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/$OWNER/$REPO/actions/runs?per_page=100&page=$page" 2>&1)
            
            api_status=$?
            
            if [ $api_status -ne 0 ]; then
              echo "âš ï¸  API call failed on page $page: $response"
              echo "   Continuing to next page..."
              ((page++))
              continue
            fi
            
            # Check if we got any runs
            run_count=$(echo "$response" | jq -r '.workflow_runs | length' 2>/dev/null)
            
            if [ -z "$run_count" ] || [ "$run_count" = "0" ]; then
              echo "âœ… No more runs found, stopping."
              break
            fi
            
            echo "   Found $run_count runs on this page"
            
            # Extract and process runs
            echo "$response" | jq -r '.workflow_runs[] | select(.conclusion == "failure" or .conclusion == "cancelled" or .conclusion == "skipped") | "\(.id)|\(.name)|\(.conclusion)"' 2>/dev/null | \
            while IFS='|' read -r run_id name conclusion; do
              if [ -z "$run_id" ]; then
                continue
              fi
              
              echo "ğŸ—‘ï¸  Deleting [$conclusion] $name (ID: $run_id)..."
              
              delete_response=$(gh api \
                --method DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "/repos/$OWNER/$REPO/actions/runs/$run_id" 2>&1)
              
              delete_status=$?
              
              if [ $delete_status -eq 0 ]; then
                echo "   âœ… Deleted"
                ((deleted++))
              else
                echo "   âš ï¸  Failed: $delete_response"
                ((failed++))
              fi
              
              # Rate limiting
              sleep 0.2
            done
            
            ((page++))
            sleep 0.5
          done
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Cleanup completed!"
          echo "ğŸ“Š Successfully deleted: $deleted"
          if [ $failed -gt 0 ]; then
            echo "âš ï¸  Failed to delete: $failed"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Always exit successfully
          exit 0
